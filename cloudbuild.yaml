steps:
  - name: 'josecyber/cloudbuild'
    id: Environment
    entrypoint: bash
    args: 
      - -c
      - |
        echo $REPO_NAME
        echo $BRANCH_NAME
        echo $SHORT_SHA
    waitFor: [-]

  - name: 'josecyber/cloudbuild'
    id: Docker build
    entrypoint: bash
    args: 
      - -c
      - |
        echo 'Docker build' | figlet 
        docker build -t chapter_sysadmin -f /src/dockerfile .
    waitFor: [Environment]

  - name: 'josecyber/cloudbuild'
    id: Docker vulnarability
    entrypoint: bash
    args: 
      - -c
      - |
        echo $REPO_NAME
    waitFor: [Docker build]
  
  - name: 'josecyber/cloudbuild'
    id: Docker push
    entrypoint: bash
    args: 
      - -c
      - |
        echo 'Docker Push' | figlet
        docker tag josecyber/chapter_sysadmin:$SHORT_SHA
        docker push josecyber/chapter_sysadmin:$SHORT_SHA

    secretEnv: ['DOCKERHUB_USR', 'DOCKERHUB_PWD']
    waitFor: [Docker vulnarability]
  
  - name: 'josecyber/cloudbuild'
    id: Kubecost
    entrypoint: bash
    args: 
      - -c
      - |
        echo 'kubecost Analasys' | filget
    waitFor: [Docker push]

availableSecrets:
  secretManager:
  - versionName: projects/164405315743//secrets/DOCKERHUB_PWD/versions/latest
    env: 'DOCKERHUB_PWD'
  - versionName: projects/164405315743/secrets/DOCKERHUB_USR/versions/latest
    env: 'DOCKERHUB_USR'
  - versionName: projects/164405315743/secrets/KUBECONFIG/versions/latest
    env: KUBECONFIG
